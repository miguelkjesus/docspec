import { AbstractClass, Key, MethodKeysOf, StripInternals } from '@/internal/utils/types'

import { CompositeNode } from './base'
import { __CommonContentBuilder, CommonContentNode } from './common'
import { AddMethod, AddStaticMethod, createMethod, MethodBuilder, MethodNode } from './method'
import {
  AddProperty,
  AddStaticProperty,
  createProperty,
  PropertyBuilder,
  PropertyNode,
} from './property'

export interface ClassNode extends CompositeNode {
  type: 'class'
  content: (CommonContentNode | PropertyNode | MethodNode)[]
}

class __ClassBuilder<Constructor extends AbstractClass>
  extends __CommonContentBuilder<ClassNode>
  implements
    AddMethod<InstanceType<Constructor>>,
    AddProperty<InstanceType<Constructor>>,
    AddStaticMethod<Constructor>,
    AddStaticProperty<Constructor>
{
  constructor() {
    super({ type: 'class', content: [] })
  }

  private _method(
    isStatic: boolean,
    key: Key,
    method: string | ((builder: MethodBuilder) => void),
  ) {
    this.__node.content.push(createMethod(isStatic, key, method))
  }

  readonly method = Object.assign(
    (
      key: MethodKeysOf<InstanceType<Constructor>>,
      method: string | ((builder: MethodBuilder) => void),
    ) => {
      this._method(false, key, method)
    },
    {
      static: (
        key: MethodKeysOf<Constructor>,
        method: string | ((builder: MethodBuilder) => void),
      ) => {
        this._method(true, key, method)
      },
    },
  )

  private _property(
    isStatic: boolean,
    key: Key,
    property: string | ((builder: PropertyBuilder) => void),
  ) {
    this.__node.content.push(createProperty(isStatic, key, property))
  }

  readonly property = Object.assign(
    (
      key: keyof InstanceType<Constructor>,
      property: string | ((builder: PropertyBuilder) => void),
    ) => {
      this._property(false, key, property)
    },
    {
      static: (key: keyof Constructor, property: string | ((builder: PropertyBuilder) => void)) => {
        this._property(true, key, property)
      },
    },
  )
}

export type ClassBuilder<T extends AbstractClass> = StripInternals<__ClassBuilder<T>>

export function createClass<T extends AbstractClass>(
  init: string | ((builder: ClassBuilder<T>) => void),
) {
  return new __ClassBuilder<T>().__build(init)
}
